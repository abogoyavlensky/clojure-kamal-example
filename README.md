# Full-stack Clojure/Script setup with deployment using Kamal

This project aims to show a setup of Clojure/Script web-application that
uses PostgreSQL as a database. Also, there is a config for
deployment the app with Kamal on **a single server**.

Key backend libs:
- Integrant
- Reitit
- Malli
- next.jdbc
- HoneySQL
- Automigrate

Key frontend libs:
- re-frame
- Reitit
- Shadow CLJS
- TailwindCSS

Other tools:
- Kamal
- GitHub Actions
- mise-en-place
- Taskfile
- Testcontainers

## Deploy

### TL;DR

TODO: quick way to deploy


### Requirements

Make sure you have Docker [installed](https://docs.docker.com/engine/install/) on your machine.

We are going to use predefined command to run dockerized version of Kamal, 
so in this case you don't need to install anything else to deploy your app.

```shell
./kamal.sh version
```

---

:information_source: **Note**: _Alternatively you can install Kamal as ruby gem 
and use just `kamal` command instead of dockerized version:_

Install [mise-en-place](https://mise.jdx.dev/getting-started.html#quickstart) (or [asdf](https://asdf-vm.com/guide/getting-started.html)), 
add `ruby 3.3.0` to `.tool-versions` file and run `mise install ruby`:

```shell
brew install libyaml  # or on Ubuntu: `sudo apt-get install libyaml-dev` 
mise install ruby
gem install kamal -v 1.5.2
kamal version
```

### Initial server setup

#### Setup environment variables

Run command `envify` to create `.env` with all required empty variables: 

```shell
./kamal.sh envify --skip-push
```

_Parameter `--skip-push` is needed to do not push `.env`-file to server._

Now, you can fill all env vars in `.env`-file with actual values for deployment on a server.
Let's check an example:
```shell
# Generated by kamal envify
# DEPLOY
SERVER_IP=192.168.0.1
REGISTRY_USERNAME=your-username
REGISTRY_PASSWORD=secret-registry-password
TRAEFIK_ACME_EMAIL=user@test.com
APP_DOMAIN=app.domain.com

# App
DATABASE_URL="jdbc:postgresql://clojure-kamal-example-db:5432/demo?user=demoadmin&password=secret-db-password"

# DB accessory
POSTGRES_DB=demo
POSTGRES_USER=demoadmin
POSTGRES_PASSWORD=secret-db-password
```

Notes:
- `SERVER_IP` - the IP of the server you wnat to deploy tour app, you should be able to connect to it using ssh-keys.
- `REGISTRY_USERNAME` and `REGISTRY_PASSWORD` - credentials for docker registry, in our case we are using `ghcr.io`, but it can be anything. 
- `TRAEFIK_ACME_EMAIL` - email for register TLS-certificate with Let's Encrypt and Traefik.
- `APP_DOMAIN` - domain of your app, should be configured to point out to `SERVER_IP`. 
- `clojure-kamal-example-db` - this is the name of the database container from accessories section of `deploy/config.yml` file.
- We duplicated database credentials to set up database container and use `DATABASE_URL` in the app. 

:warning: _Do not include file `.env` to git repository!_ 

#### Bootstrap server and deploy app

Install Docker on a server:

```shell
./kamal.sh server bootstrap
```

Create docker network to have access to database container from the app by container name
and directory for Let's Encrypt certificates:

```shell
ssh root@192.168.0.1 'docker network create traefik'
ssh root@192.168.0.1 'mkdir -p /root/letsencrypt && touch /root/letsencrypt/acme.json && chmod 600 /root/letsencrypt/acme.json'
```

Set up Traefik, database, environment variables and run app on a server:

```shell
./kamal.sh setup
```

The app is deployed on the server, but it is not fully functioning yet, we need to run database migrations:

```shell
kamal app exec 'java -jar standalone.jar migrations'
```

Now, we the application fully deployed on the server.

### Regular deploy

Then, next time for deploy the app from local machine, run:

```shell
kamal deploy
```

Or just push to the master, there is a GitHub Actions pipeline that does 
the deployment automatically `.github/workflows/deploy.yaml`.

### Setup CI for deployment

For CI setup you need to add following environment variables

TODO:...
